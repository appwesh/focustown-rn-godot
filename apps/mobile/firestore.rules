rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // Helper Functions
    // ========================================================================
    
    // Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }
    
    // Check if user owns this document (by uid field)
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    // Check if user is in an array field
    function isInArray(arr) {
      return request.auth.uid in arr;
    }
    
    // ========================================================================
    // Users Collection
    // ========================================================================
    
    match /users/{uid} {
      // Anyone authenticated can read user profiles (for presence, friends)
      allow read: if isAuth();
      
      // Users can only create/update their own document
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
      
      // Never delete users from client
      allow delete: if false;
    }
    
    // ========================================================================
    // Sessions Collection
    // ========================================================================
    
    match /sessions/{sessionId} {
      // Anyone authenticated can read sessions (for presence display)
      allow read: if isAuth();
      
      // Users can only create sessions for themselves
      allow create: if isAuth() 
        && request.resource.data.odId == request.auth.uid;
      
      // Users can only update their own sessions
      allow update: if isAuth() 
        && resource.data.odId == request.auth.uid;
      
      // Don't delete sessions (use status field instead)
      allow delete: if false;
    }
    
    // ========================================================================
    // Friendships Collection
    // ========================================================================
    
    match /friendships/{friendshipId} {
      // Only involved users can read
      allow read: if isAuth() 
        && isInArray(resource.data.users);
      
      // Either user can create (when sending request)
      allow create: if isAuth() 
        && isInArray(request.resource.data.users);
      
      // Either user can update (accept/decline/block)
      allow update: if isAuth() 
        && isInArray(resource.data.users);
      
      // Either user can delete (unfriend/decline)
      allow delete: if isAuth() 
        && isInArray(resource.data.users);
    }
    
    // ========================================================================
    // Group Sessions Collection
    // ========================================================================
    
    match /groupSessions/{groupId} {
      // Host and participants can read
      allow read: if isAuth() && (
        resource.data.hostId == request.auth.uid ||
        isInArray(resource.data.participantIds)
      );
      
      // Only host can create
      allow create: if isAuth() 
        && request.resource.data.hostId == request.auth.uid;
      
      // Host can update (start/complete/cancel)
      // Participants are added via Cloud Functions or with specific rules
      allow update: if isAuth() && (
        resource.data.hostId == request.auth.uid ||
        // Allow participants to be added (for accepting invites)
        (isInArray(resource.data.participantIds) == false 
          && request.resource.data.participantIds.hasAll(resource.data.participantIds)
          && request.resource.data.participantIds.size() == resource.data.participantIds.size() + 1
          && request.auth.uid in request.resource.data.participantIds)
      );
      
      // Never delete (use status)
      allow delete: if false;
    }
    
    // ========================================================================
    // Group Invites Collection
    // ========================================================================
    
    match /groupInvites/{inviteId} {
      // Invited user or host can read
      allow read: if isAuth() && (
        resource.data.odId == request.auth.uid ||
        resource.data.hostId == request.auth.uid
      );
      
      // Only host can create invites
      allow create: if isAuth() 
        && request.resource.data.hostId == request.auth.uid;
      
      // Invited user can update (accept/decline)
      allow update: if isAuth() 
        && resource.data.odId == request.auth.uid;
      
      // Either can delete (cancel invite)
      allow delete: if isAuth() && (
        resource.data.odId == request.auth.uid ||
        resource.data.hostId == request.auth.uid
      );
    }
  }
}
